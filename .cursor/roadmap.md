# Difftest

目前，我们已经实现了一个基本的riscv虚拟机，能够正常运行了，但是我们如何对其进行测试呢？综合成本和准确性来看，最好的测试方法是difftest,具体来说，我们安排一个绝对正确的参考实现ref,将当前待测试的虚拟机视作dut,dut和ref拥有完全相同的初始状态，每运行一条指令，两者就整个寄存器文件进行一轮完整比对，出错则报错，这样就能够精细到具体是哪一条指令出现问题了

## 问题
那么，如何实现这个功能呢？实现难度其实并不高，最大的问题在于性能，difftest会极大的降低模拟器运行的效率，而且哪怕使用状态量在某些情况下关闭difftest,也会带来巨大的开销，比如说
- 在每一条指令运行结束后都检查一次是否需要进行difftest
- 在state模块中需要检查是否存在mmio访问，如果存在，要让ref停止运行一周期并且将dut的整个寄存器文件复制给ref一份，来保证两者同步，因为ref实际上不会仿真设备

## 解决方案
difftest不可能说仿真进行到一般再开启，这一定是通过主函数参数提前决定是否要开启的，换而言之，我们可以专门为是否开启difftest设计两套代码，但是这会带来心智负担，维护负担，而且违反DRY(Don't repeat yourself)原则，所以最好的答案是泛型！

我打算在代码中大量使用泛型，用来处理所有可以提前决定的两并为之在编译期生成性能最好的单例，比如说
- ISA
- 位宽
- 是否开启difftest
等

## 如何实现
既然我们如此大量的使用泛型，那么就不得不考虑不一个好的处理了，我打算沿用decition中对command和option分层处理的哲学，想要让泛型在不同层分层处理，向上层掩盖细节
